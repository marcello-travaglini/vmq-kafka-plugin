%%--------------------------------------------------------------------
%% rebar.config for vmq_kafka_plugin
%%
%% Supports:
%%   - Development builds (`rebar3 compile`)
%%   - Production/release builds (`rebar3 release` or `rebar3 as prod release`)
%%
%% Key features:
%%   - Static release version (must be kept in sync with src/vmq_kafka_plugin.app.src)
%%   - Includes 'sasl' in the release for OTP release handling and hot upgrades
%%   - Separate profiles for dev and prod
%%   - Alias so `rebar3 release` always uses the prod profile
%%--------------------------------------------------------------------

%%--------------------------------------------------------------------
%% Compiler options (default profile: development)
%%--------------------------------------------------------------------
%% Keep debug_info in development for better stack traces, debugging,
%% and use with tools like observer.
{erl_opts, [debug_info]}.

%%--------------------------------------------------------------------
%% Dependencies
%%--------------------------------------------------------------------
%% vernemq_dev : VerneMQ development headers and behaviours
%% brod        : Kafka client for Erlang
%% snappyer    : Snappy compression library (used by brod if enabled)
{deps, [
    {vernemq_dev,
        {git, "https://github.com/vernemq/vernemq_dev.git", {branch, "master"}}},
    {brod, "4.4.6"},
    {snappyer, "1.2.10"}
]}.

%%--------------------------------------------------------------------
%% Shell configuration
%%--------------------------------------------------------------------
%% Allows starting an interactive shell with the plugin application loaded.
%% Example: `rebar3 shell`
{shell, [
    %% {config, "config/sys.config"}, %% Optional: load runtime config
    {apps, [vmq_kafka_plugin]}
]}.

%%--------------------------------------------------------------------
%% Release configuration (relx)
%%--------------------------------------------------------------------
%% Static version: must be manually kept in sync with vmq_kafka_plugin.app.src
%% 'sasl' is included to enable OTP release handling and hot upgrades.
{relx, [
    {release, {vmq_kafka_plugin, "0.1.0"},
     [kernel, stdlib, sasl, vmq_kafka_plugin]},

    {dev_mode, false},            %% Production mode: copy BEAMs, no symlinks
    {include_erts, true},         %% Include the Erlang Runtime System
    {extended_start_script, true} %% Generate extended start script
]}.

%%--------------------------------------------------------------------
%% Build profiles
%%--------------------------------------------------------------------
%% Profiles allow different compiler options and settings for dev vs prod.
{profiles, [
    {prod, [
        %% Remove debug_info for smaller, faster BEAM files
        %% Treat warnings as errors to enforce clean builds
        %% Inline small functions for performance
        %% Enable HiPE native compilation with optimization level 3 (optional)
        {erl_opts, [no_debug_info, warnings_as_errors, inline, {hipe, [o3]}]},

        %% Exclude test-related applications from the release
        {exclude_apps, [eunit, common_test]}
    ]}
]}.

%%--------------------------------------------------------------------
%% Aliases
%%--------------------------------------------------------------------
%% Override the `release` command to always build using the `prod` profile.
%% This means `rebar3 release` will actually run `rebar3 as prod release`.
{aliases, [
    {release, [as, prod, release]}
]}.
